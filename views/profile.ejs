<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen font-sans">

  <!-- Container with responsive 2-col layout -->
  <div class="mx-auto max-w-6xl px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- Left sidebar: profile, composer, user's posts -->
    <aside class="space-y-6 lg:col-span-1 lg:sticky lg:top-6 lg:h-[calc(100vh-3rem)] lg:overflow-y-auto">

      <!-- Profile Info -->
      <section class="bg-gray-800 rounded-lg p-6 shadow-md">
        <div class="flex items-center gap-5 mb-5">
          <img
            src="/images/uploads/<%= (user && user.profilepic) ? user.profilepic : 'default.jpg' %>"
            alt="Avatar"
            class="w-20 h-20 rounded-full object-cover border-2 border-gray-700"
          />
          <div>
            <h1 class="text-2xl font-bold mb-1 truncate">
              Welcome, <%= (user && (user.username || user.email)) ? (user.username || user.email) : 'User' %>
            </h1>
            <p class="text-gray-400 text-sm select-text">
              User ID: <%= (user && (user._id || user.userid)) ? (user._id || user.userid) : '' %>
            </p>
          </div>
        </div>
        <div class="flex gap-3">
          <a href="/logout"
             class="bg-red-600 hover:bg-red-700 transition-colors px-4 py-2 rounded-md font-semibold text-center w-full">
            Logout
          </a>
          <a href="/profile/upload"
             class="bg-zinc-700 hover:bg-zinc-600 transition-colors px-4 py-2 rounded-md font-semibold text-center w-full">
            Upload Avatar
          </a>
        </div>
      </section>

      <!-- Composer -->
      <section class="bg-gray-800 rounded-lg p-6 shadow-md">
        <form method="POST" action="/posts">
          <textarea
            name="content"
            placeholder="What's on your mind?"
            class="w-full bg-gray-700 rounded-md p-3 text-gray-200 placeholder-gray-400 outline-none resize-none mb-4 min-h-[80px]"
            rows="3"
            required
          ></textarea>
          <button type="submit"
                  class="w-full bg-blue-600 hover:bg-blue-700 transition-colors px-4 py-2 rounded-md font-semibold">
            Post
          </button>
        </form>
      </section>

      <!-- User's Own Posts -->
      <section class="space-y-4 max-h-[40vh] overflow-y-auto pr-2">
        <h2 class="text-xl font-semibold border-b border-gray-700 pb-2 mb-3">Your Posts</h2>

        <% const hasUserPosts = user && Array.isArray(user.posts) && user.posts.length > 0; %>
        <% if (hasUserPosts) { %>
          <% user.posts.slice().reverse().forEach(function(p) { 
               const uid = String(user.userid || user._id || '');
               const likedByUser = (p.likes || []).map(String).includes(uid);
          %>
            <article class="bg-gray-800 rounded-lg p-4 shadow hover:shadow-lg transition-shadow duration-200">
              <header class="flex items-center gap-3 mb-3">
                <img
                  src="/images/uploads/<%= (user && user.profilepic) ? user.profilepic : 'default.jpg' %>"
                  alt="Avatar"
                  class="w-8 h-8 rounded-full object-cover border border-gray-600"
                />
                <span class="font-semibold truncate max-w-[12rem]"><%= (user.username || user.email || 'User') %></span>
              </header>

              <p class="text-gray-200 whitespace-pre-wrap break-words mb-2"><%= p.content %></p>
              <p class="text-gray-500 text-xs font-mono">
                <%= (p.createdAt ? new Date(p.createdAt) : (p.date ? new Date(p.date) : new Date())).toLocaleString() %>
              </p>

              <div class="flex items-center gap-2 mt-3">
                <a href="/like/<%= p._id %>"
                   class="<%= likedByUser ? 'bg-green-700 hover:bg-green-800' : 'bg-green-600 hover:bg-green-700' %> px-3 py-1 rounded-md text-sm font-semibold select-none transition-colors duration-150">
                  üëç <%= likedByUser ? 'Unlike' : 'Like' %>
                </a>
                <small class="text-blue-400 text-sm font-medium">
                  <%= (p.likes && p.likes.length) ? p.likes.length : 0 %> Likes
                </small>
                
                <a href="/posts/<%= p._id %>/edit"
                   class="bg-yellow-500 hover:bg-yellow-600 px-3 py-1 rounded-md text-sm font-semibold ml-auto select-none transition-colors duration-150">
                  ‚úèÔ∏è Edit
                </a>
              </div>
            </article>
          <% }) %>
        <% } else { %>
          <p class="text-gray-400">No posts yet.</p>
        <% } %>
      </section>
    </aside>

    <!-- Right main column: Global feed -->
    <main class="lg:col-span-2 overflow-y-auto max-h-[90vh] pr-4">
      <h2 class="text-3xl font-bold mb-6 border-b border-gray-700 pb-3">Global Feed</h2>

      <% if (allPosts && allPosts.length > 0) { %>
        <div class="space-y-6">
          <% allPosts.forEach(function(p) {
               const uid = String((user && (user.userid || user._id)) || '');
               const likedByUser = (p.likes || []).map(String).includes(uid);
               const userName = (p.user && (p.user.username || p.user.email)) ? (p.user.username || p.user.email) : 'User';
               const pic = (p.user && p.user.profilepic) ? `/images/uploads/${p.user.profilepic}` : '/images/uploads/default.jpg';
               const id = (p.user && p.user._id) ? p.user._id : '';
          %>
            <article class="bg-gray-800 rounded-xl p-6 shadow-md hover:shadow-xl transition-shadow duration-300">
              <header class="flex items-center gap-4 mb-5">
                <img
                  src="<%= pic %>"
                  alt="Author Avatar"
                  class="w-12 h-12 rounded-full object-cover border-2 border-gray-600"
                />
                <div class="flex flex-col min-w-0">
                  <a href="/users/<%= id %>"
                    class="font-semibold text-lg hover:underline truncate max-w-[25rem]">
                    <%= userName %>
                  </a>
                  <time class="text-gray-400 text-sm truncate font-mono"
                        datetime="<%= p.createdAt ? p.createdAt.toISOString() : new Date().toISOString() %>">
                    ‚Ä¢ <%= p.createdAt ? new Date(p.createdAt).toLocaleString() : new Date().toLocaleString() %>
                  </time>
                </div>
              </header>

              <p class="text-gray-200 whitespace-pre-wrap break-words mb-5 text-base leading-relaxed"><%= p.content %></p>

              <div class="flex items-center gap-5">
                <a href="/like/<%= p._id %>"
                   class="<%= likedByUser ? 'bg-green-700 hover:bg-green-800' : 'bg-green-600 hover:bg-green-700' %> px-4 py-2 rounded-md text-sm font-semibold flex items-center gap-2 select-none transition-colors duration-200">
                  üëç <span><%= likedByUser ? 'Unlike' : 'Like' %></span>
                </a>
                <span class="text-blue-400 text-sm font-medium">
                  <%= (p.likes && p.likes.length) ? p.likes.length : 0 %> Likes
                </span>

                <!-- <a href="/posts/<%= p._id %>"
                   class="ml-auto text-sm text-zinc-400 hover:text-white underline underline-offset-4 select-none">
                  View details
                </a> -->
              </div>
            </article>
          <% }) %>
        </div>
      <% } else { %>
        <p class="text-gray-400 text-center mt-10 text-lg">No posts in the global feed yet.</p>
      <% } %>
    </main>

  </div>

</body>
</html>
