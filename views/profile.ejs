<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">

  <!-- 2-col layout container -->
  <div class="mx-auto max-w-6xl px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left column: profile + composer + user's posts -->
    <aside class="space-y-6 lg:col-span-1 lg:sticky lg:top-0 lg:h-screen lg:overflow-auto">
      <!-- Profile Info -->
      <div class="bg-gray-800 rounded-lg p-6 shadow">
        <div class="flex items-center gap-4 mb-4">
          <img
            src="/images/uploads/<%= (user && user.profilepic) ? user.profilepic : 'default.jpg' %>"
            alt="Avatar"
            class="w-20 h-20 rounded-full object-cover"
          />
          <div>
            <h1 class="text-2xl font-bold mb-1">
              Welcome, <%= (user && (user.username || user.email)) ? (user.username || user.email) : 'User' %>
            </h1>
            <p class="text-gray-400">
              User ID: <%= (user && (user._id || user.userid)) ? (user._id || user.userid) : '' %>
            </p>
          </div>
        </div>
        <div class="flex gap-3">
          <a href="/logout"
             class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-md font-semibold inline-block">
            Logout
          </a>
          <a href="/profile/upload"
             class="bg-zinc-700 hover:bg-zinc-600 px-4 py-2 rounded-md font-semibold inline-block">
            Upload Avatar
          </a>
        </div>
      </div>

      <!-- Composer -->
      <div class="bg-gray-800 rounded-lg p-6 shadow">
        <form method="post" action="/posts">
          <textarea
            name="content"
            placeholder="What's on your mind?"
            class="w-full bg-gray-700 rounded-md p-3 text-gray-200 placeholder-gray-400 outline-none resize-none mb-4"
            rows="3"
            required
          ></textarea>
          <button type="submit"
                  class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-md font-semibold">
            Post
          </button>
        </form>
      </div>

      <!-- User's Own Posts -->
      <div class="space-y-4">
        <h2 class="text-xl font-semibold">Your Posts</h2>

        <% const hasUserPosts = user && Array.isArray(user.posts) && user.posts.length > 0; %>
        <% if (hasUserPosts) { %>
          <% user.posts.slice().reverse().forEach(function(p) { 
               const uid = String(user.userid || user._id || '');
               const likedByUser = (p.likes || []).map(String).includes(uid);
          %>
            <article class="bg-gray-800 rounded-lg p-4 shadow">
              <header class="flex items-center gap-3 mb-2">
                <img
                  src="/images/uploads/<%= (user && user.profilepic) ? user.profilepic : 'default.jpg' %>"
                  alt="Avatar"
                  class="w-8 h-8 rounded-full object-cover"
                />
                <span class="font-semibold"><%= (user.username || user.email || 'User') %></span>
              </header>

              <p class="text-gray-200 whitespace-pre-wrap break-words"><%= p.content %></p>
              <p class="text-gray-500 text-xs mt-2">
                <%= (p.createdAt ? new Date(p.createdAt) : (p.date ? new Date(p.date) : new Date())).toLocaleString() %>
              </p>

              <div class="flex items-center gap-2 mt-3">
                <a href="/like/<%= p._id %>"
                   class="<%= likedByUser ? 'bg-green-700 hover:bg-green-800' : 'bg-green-600 hover:bg-green-700' %> px-3 py-1 rounded-md text-sm font-semibold">
                  üëç <%= likedByUser ? 'Unlike' : 'Like' %>
                </a>
                <small class="text-blue-400 text-sm">
                  <%= (p.likes && p.likes.length) ? p.likes.length : 0 %> Likes
                </small>

                <a href="/posts/<%= p._id %>/edit"
                   class="bg-yellow-500 hover:bg-yellow-600 px-3 py-1 rounded-md text-sm font-semibold ml-auto">
                  ‚úèÔ∏è Edit
                </a>
              </div>
            </article>
          <% }) %>
        <% } else { %>
          <p class="text-gray-400">No posts yet.</p>
        <% } %>
      </div>
    </aside>

    <!-- Right column: Global feed -->
    <main class="lg:col-span-2">
      <h2 class="text-xl font-semibold mb-4">Global Feed</h2>

      <% const hasAllPosts = (typeof allPosts !== 'undefined') && Array.isArray(allPosts) && allPosts.length > 0; %>
      <% if (hasAllPosts) { %>
        <div class="space-y-4">
          <% allPosts.forEach(function(p) {
               const uid = String((user && (user.userid || user._id)) || '');
               const likedByUser = (p.likes || []).map(String).includes(uid);
               const authorName = (p.author && (p.author.username || p.author.email)) ? (p.author.username || p.author.email) : 'User';
               const authorPic  = (p.author && p.author.profilepic) ? `/images/uploads/${p.author.profilepic}` : '/images/uploads/default.jpg';
               const authorId   = (p.author && (p.author._id)) ? p.author._id : '';
          %>
            <article class="bg-gray-800 rounded-lg p-5 shadow">
              <header class="flex items-center gap-3 mb-2">
                <img
                  src="<%= authorPic %>"
                  alt="Author Avatar"
                  class="w-9 h-9 rounded-full object-cover"
                />
                <div class="min-w-0">
                  <div class="flex items-center gap-2">
                    <a href="/users/<%= authorId %>"
                       class="font-semibold hover:underline truncate">
                      <%= authorName %>
                    </a>
                    <span class="text-gray-500 text-xs truncate">
                      ‚Ä¢ <%= (p.createdAt ? new Date(p.createdAt) : (p.date ? new Date(p.date) : new Date())).toLocaleString() %>
                    </span>
                  </div>
                </div>
              </header>

              <p class="text-gray-200 whitespace-pre-wrap break-words"><%= p.content %></p>

              <div class="mt-3 flex items-center gap-3">
                <a href="/like/<%= p._id %>"
                   class="<%= likedByUser ? 'bg-green-700 hover:bg-green-800' : 'bg-green-600 hover:bg-green-700' %> px-3 py-1 rounded-md text-sm font-semibold">
                  üëç <%= likedByUser ? 'Unlike' : 'Like' %>
                </a>
                <span class="text-blue-400 text-sm">
                  <%= (p.likes && p.likes.length) ? p.likes.length : 0 %> Likes
                </span>

                <a href="/posts/<%= p._id %>"
                   class="ml-auto text-sm text-zinc-300 hover:text-white underline underline-offset-4">
                  View details
                </a>
              </div>
            </article>
          <% }) %>
        </div>
      <% } else { %>
        <p class="text-gray-400">No posts in the global feed yet.</p>
      <% } %>
    </main>
  </div>

</body>
</html>
